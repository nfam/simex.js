/**
 * @license
 * Copyright (c) 2015 Ninh Pham <ninhpham@hotmail.com>
 *
 * Use of this source code is governed by The MIT license.
 */
var __extends=this&&this.__extends||function(){var extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])};return function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}();!function(factory){if("object"==typeof module&&"object"==typeof module.exports){var v=factory(require,exports);void 0!==v&&(module.exports=v)}else"function"==typeof define&&define.amd&&define(["require","exports"],factory)}(function(require,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var ArrayExp=function(){function ArrayExp(path,json,processors){var _this=this;if(this.path=path,"object"!=typeof json||json instanceof Array||null===json)throw new AtError(messages.array,this.path);if(!json.hasOwnProperty("separator"))throw new AtError(messages.separatorMissing,this.path);this.separatorIsArray=json.separator instanceof Array;var array=this.separatorIsArray?json.separator:[json.separator];if(this.separator=array.map(function(item,index){if("string"==typeof item&&item.length>0)return item;throw new AtError(messages.separator,_this.path+".separator"+(_this.separatorIsArray?"["+index+"]":""))}),0==this.separator.length)throw new AtError(messages.separator,this.path+".separator");if(json.hasOwnProperty("omit")){if("boolean"!=typeof json.omit)throw new AtError(messages.omit,this.path+".omit");this.omit=json.omit}if(json.hasOwnProperty("item")){this.itemIsArray=json.item instanceof Array;array=this.itemIsArray?json.item:[json.item];if(this.item=array.map(function(item,index){if(null===item){if(_this.itemIsArray)return null;throw new AtError(messages.item,_this.path+".item")}var location_1=_this.path+".item"+(_this.itemIsArray?"["+index+"]":"");return new Slice(location_1,item,processors,messages.item)}),0==this.item.length)throw new AtError(messages.item,this.path+".item")}}return ArrayExp.prototype.extract=function(input){for(var results=[],parts=[input],_i=0,_a=this.separator;_i<_a.length;_i++){for(var separator=_a[_i],groups=[],i=0;i<parts.length;i+=1)groups[i]=parts[i].split(separator);parts=[].concat.apply([],groups)}for(var omit=!!this.omit,_b=0,parts_1=parts;_b<parts_1.length;_b++){var part=parts_1[_b];if(!omit||""!==part)if(this.item)if(this.itemIsArray){for(var errors=[],_c=0,_d=this.item;_c<_d.length;_c++){var slice=_d[_c];if(!slice){errors=[];break}try{results.push(slice.extract(part)),errors=[];break}catch(error){errors.push(error)}}if(errors.length>0){var location_2=errors.map(function(error){return error.at}).join("\n");throw new AtError(messages.inputUnmatched,location_2)}}else results.push(this.item[0].extract(part));else results.push(part)}return results},ArrayExp.prototype.toJSON=function(){var json={};return this.separatorIsArray?json.separator=this.separator:json.separator=this.separator[0],void 0!==this.omit&&(json.omit=this.omit),void 0!==this.item&&(this.itemIsArray?json.item=this.item.map(function(slice){return slice?slice.toJSON():null}):json.item=this.item[0].toJSON()),json},ArrayExp}(),AtError=function(_super){function AtError(message,at){var _this=_super.call(this,message)||this;return""===at?_this.at="":0==at.indexOf("@ ")?_this.at=at:_this.at="@ "+at,_this}return __extends(AtError,_super),AtError}(Error);function addMessageAt(error){"string"==typeof error.at&&"string"==typeof error.message&&""!==error.at&&(error.message+="\n"+error.at)}var messages={array:'Property "array" must be an object.',backward:'Property "backward" must be boolean.',between:'Property "between" must be an object or an array of object.',by:'Property "by" must be a string.',byMissing:'Property "by" is missing.',dictionary:'Property "dictionary" must be an object.',expression:'Expression must be an object with the required property "root".',has:'Property "has" must be a string.',item:'Property "item" must be an object or a non-empty array of object and null.',member:"Member value of dictionary must be an object or a non-empty array of object and null.",omit:'Property "omit" must be true or false.',root:'Property "root" must be an object.',rootMissing:'Property "root" is missing.',prefix:'Property "prefix" must be either a string or an array of strings.',process:'Property "process" must be a string, an object, or an array of string and object.',processUndefined:"Function is not found in processors.",separator:'Property "separator" must be either a non-empty string or an array of non-empty strings.',separatorMissing:'Property "separator" is missing.',slice:'Property "slice" must be an object or an non-empty array of object.',subexpressions:"Only one of value, slice, array, and dictionary shall be defined.",suffix:'Property "suffix" must be either a string or an array of strings.',trim:'Property "trim" must be boolean.',inputUnmatched:"Provided input does not match the expression.",with:'Property "with" must be either a string or an array of strings.'},Between=function(){function Between(path,json){var _this=this;if(this.path=path,"object"!=typeof json||json instanceof Array||null===json)throw new AtError(messages.between,this.path);if(json.hasOwnProperty("backward")){if("boolean"!=typeof json.backward)throw new AtError(messages.backward,this.path+".backward");this.backward=json.backward}if(json.hasOwnProperty("prefix")){this.prefixIsArray=json.prefix instanceof Array;var array=this.prefixIsArray?json.prefix:[json.prefix];this.prefix=array.map(function(item,index){if("string"==typeof item)return item;throw new AtError(messages.prefix,_this.path+".prefix"+(_this.prefixIsArray?"["+index+"]":""))})}if(json.hasOwnProperty("suffix")){this.suffixIsArray=json.suffix instanceof Array;array=this.suffixIsArray?json.suffix:[json.suffix];this.suffix=array.map(function(item,index){if("string"==typeof item)return item;throw new AtError(messages.suffix,_this.path+".suffix"+(_this.suffixIsArray?"["+index+"]":""))})}if(json.hasOwnProperty("trim")){if("boolean"!=typeof json.trim)throw new AtError(messages.trim,this.path+".trim");this.trim=json.trim}}return Between.prototype.extract=function(input){for(var str=input,prefixes=this.prefix||[],index=0;index<prefixes.length;index+=1){var prefix=prefixes[index];if(prefix.length>0)if(this.backward){if(!((end=str.lastIndexOf(prefix))>=0)){var location_3=this.path+".prefix"+(this.prefixIsArray?"["+index+"]":"");throw new AtError(messages.inputUnmatched,location_3)}str=str.substring(0,end)}else{if(!((start=str.indexOf(prefix))>=0)){var location_4=this.path+".prefix"+(this.prefixIsArray?"["+index+"]":"");throw new AtError(messages.inputUnmatched,location_4)}str=str.substring(start+prefix.length)}}for(var suffixed=!1,suffixesCount=0,_i=0,_a=this.suffix||[];_i<_a.length;_i++){var start,end,suffix=_a[_i];if(suffixesCount+=1,!(suffix.length>0)){suffixed=!0;break}if(this.backward){if((start=str.lastIndexOf(suffix))>=0){str=str.substring(start+suffix.length),suffixed=!0;break}}else if((end=str.indexOf(suffix))>=0){str=str.substring(0,end),suffixed=!0;break}}if(!suffixed&&suffixesCount>0)throw new AtError(messages.inputUnmatched,this.path+".suffix");return this.trim&&(str=str.trim()),str},Between.prototype.toJSON=function(){var json={};return void 0!==this.backward&&(json.backward=this.backward),void 0!==this.prefix&&(json.prefix=this.prefixIsArray?this.prefix:this.prefix[0]),void 0!==this.suffix&&(json.suffix=this.suffixIsArray?this.suffix:this.suffix[0]),void 0!==this.trim&&(json.trim=this.trim),json},Between}(),Dictionary=function(){function Dictionary(path,json,processors){var _this=this;if(this.path=path,"object"!=typeof json||json instanceof Array||null===json)throw new AtError(messages.dictionary,this.path);this.members={},Object.keys(json).forEach(function(name){var value=json[name];if("object"!=typeof value)throw new AtError(messages.member,_this.path+'["'+name+'"]');if(value instanceof Array){for(var slices=[],index=0;index<value.length;index+=1){var item=value[index];if(null===item)slices.push(null);else{var location_5=_this.path+'["'+name+'"]['+index+"]";slices.push(new Slice(location_5,item,processors,messages.member))}}if(0==slices.length)throw new AtError(messages.member,_this.path+'["'+name+'"]');_this.members[name]=slices}else{var location_6=_this.path+'["'+name+'"]';_this.members[name]=new Slice(location_6,value,processors,messages.member)}})}return Dictionary.prototype.extract=function(input){for(var dictionary={},_i=0,names_1=Object.keys(this.members);_i<names_1.length;_i++){var name_1=names_1[_i],member=this.members[name_1];if(member instanceof Array){for(var errors=[],index=0;index<member.length;index+=1){var item=member[index];if(null===item){errors=[];break}try{dictionary[name_1]=item.extract(input),errors=[];break}catch(error){errors.push(error)}}if(errors.length>0){var location_7=errors.map(function(error){return error.at}).join("\n");throw new AtError(messages.inputUnmatched,location_7)}}else dictionary[name_1]=member.extract(input)}return dictionary},Dictionary.prototype.toJSON=function(){var _this=this,json={};return Object.keys(this.members).forEach(function(name){var member=_this.members[name];member instanceof Array?json[name]=member.map(function(item){return item?item.toJSON():null}):json[name]=member.toJSON()}),json},Dictionary}(),Expression=function(){function Expression(json,processors){processors=processors||{};try{if("object"!=typeof json||json instanceof Array||null===json)throw new AtError(messages.expression,"");if(!json.hasOwnProperty("root"))throw new AtError(messages.rootMissing,"");this.root=new Slice("root",json.root,processors,messages.root)}catch(error){throw addMessageAt(error),error}}return Expression.prototype.extract=function(input){try{return function avoidMemoryLeak(item){if("string"==typeof item)item=(" "+item).substring(1);else if("object"==typeof item){if(null===item)return null;if(item instanceof Array)for(var i=0;i<item.length;i+=1)item[i]=avoidMemoryLeak(item[i]);else Object.keys(item).forEach(function(key){item[key]=avoidMemoryLeak(item[key])})}return item}(this.root.extract(input))}catch(error){throw addMessageAt(error),error}},Expression.prototype.toJSON=function(){return{root:this.root.toJSON()}},Expression}();exports.Expression=Expression;var Process=function(){function Process(path,json,processors){var _this=this;if(this.path=path,"string"==typeof json)this.processIsObject=!1,this.by=json;else{if("object"!=typeof json||json instanceof Array||null===json)throw new AtError(messages.process,this.path);if(this.processIsObject=!0,!json.hasOwnProperty("by"))throw new AtError(messages.byMissing,this.path);if("string"!=typeof json.by)throw new AtError(messages.by,this.path+".by");if(this.by=json.by,json.hasOwnProperty("with")){this.withIsArray=json.with instanceof Array;var array=this.withIsArray?json.with:[json.with];this.with=array.map(function(item,index){if("string"==typeof item)return item;throw new AtError(messages.with,_this.path+".with"+(_this.withIsArray?"["+index+"]":""))})}}if(this.func=processors[this.by],!this.func&&(this.func=defaultProcessors[this.by],!this.func))throw new AtError(messages.processUndefined,this.path+(this.processIsObject?".by":""))}return Process.prototype.extract=function(input){try{return this.func(input,this.with)}catch(e){var error=new AtError(messages.inputUnmatched,this.path);throw e.stack&&(error.stack=e.stack),error}},Process.prototype.toJSON=function(){if(this.processIsObject){var json={by:this.by};return this.with&&(json.with=this.withIsArray?this.with:this.with[0]),json}return this.by},Process}(),defaultProcessors={append:function(input,args){return args?input+args.join(""):input},prepend:function(input,args){return args?args.join("")+input:input},replace:function(input,args){if(args)for(var i=0;i+1<args.length;i+=2)input=input.split(args[i]).join(args[i+1]);return input},replaceTo:function(input,args){return args&&2==args.length?args[0].split(args[1]).join(input):input},unescape:function(input,args){if(args)for(var _i=0,args_1=args;_i<args_1.length;_i++){switch(args_1[_i]){case"xml":input=input.replace(xmlRegex,function(s){if("#"===s.charAt(1)){var code="x"===s.charAt(2).toLowerCase()?parseInt(s.substr(3),16):parseInt(s.substr(2));return isNaN(code)||code<-32768||code>65535?s:String.fromCharCode(code)}return xmlMap[s]||s});break;case"js":input=input.replace(jsRegex,function(substr,__,varHex,longHex,shortHex,octal,specialCharacter,python){if(void 0!==varHex){var code=parseInt(varHex,16);return isNaN(code)||code>65535?substr:String.fromCharCode(code)}if(void 0!==longHex){code=parseInt(longHex,16);return String.fromCharCode(code)}if(void 0!==shortHex){code=parseInt(shortHex,16);return String.fromCharCode(code)}if(void 0!==octal){code=parseInt(octal,8);return String.fromCharCode(code)}return jsMap[specialCharacter]})}}return input}},xmlRegex=/&#?[0-9a-zA-Z]+;?/g,xmlMap={"&lt;":"<","&gt;":">","&quot;":'"',"&apos;":"'","&amp;":"&"},jsRegex=/\\(u\{([0-9A-Fa-f]+)\}|u([0-9A-Fa-f]{4})|x([0-9A-Fa-f]{2})|([1-7][0-7]{0,2}|[0-7]{2,3})|(['"tbrnfv0\\]))/g,jsMap={0:"\0",b:"\b",f:"\f",n:"\n",r:"\r",t:"\t",v:"\v","'":"'",'"':'"',"\\":"\\"},Slice=function(){function Slice(path,json,processors,typeError){var _this=this;if(this.path=path,"object"!=typeof json||json instanceof Array||null===json)throw new AtError(typeError,this.path);if(json.hasOwnProperty("has")){if("string"!=typeof json.has)throw new AtError(messages.has,this.path+".has");this.has=json.has}if(json.hasOwnProperty("between")){this.betweenIsArray=json.between instanceof Array;var array=this.betweenIsArray?json.between:[json.between];this.between=array.map(function(item,index){var location=_this.path+".between"+(_this.betweenIsArray?"["+index+"]":"");return new Between(location,item)})}if(json.hasOwnProperty("process")){this.processIsArray=json.process instanceof Array;array=this.processIsArray?json.process:[json.process];this.process=array.map(function(item,index){var location=_this.path+".process"+(_this.processIsArray?"["+index+"]":"");return new Process(location,item,processors)})}if(json.hasOwnProperty("value")){if(json.hasOwnProperty("slice")||json.hasOwnProperty("array")||json.hasOwnProperty("dictionary"))throw new AtError(messages.subexpressions,this.path);this.value=json.value}else if(json.hasOwnProperty("slice")){if(json.hasOwnProperty("array")||json.hasOwnProperty("dictionary"))throw new AtError(messages.subexpressions,this.path);this.sliceIsArray=json.slice instanceof Array;array=this.sliceIsArray?json.slice:[json.slice];if(this.slice=array.map(function(item,index){return new Slice(_this.path+".slice"+(_this.sliceIsArray?"["+index+"]":""),item,processors,messages.slice)}),0==this.slice.length)throw new AtError(messages.slice,this.path+".slice")}else if(json.hasOwnProperty("array")){if(json.hasOwnProperty("dictionary"))throw new AtError(messages.subexpressions,this.path);this.array=new ArrayExp(this.path+".array",json.array,processors)}else json.hasOwnProperty("dictionary")&&(this.dictionary=new Dictionary(this.path+".dictionary",json.dictionary,processors))}return Slice.prototype.extract=function(input){if(this.has&&this.has.length>0&&input.indexOf(this.has)<0)throw new AtError(messages.inputUnmatched,this.path+".has");var str=input;if(this.between)for(var _i=0,_a=this.between;_i<_a.length;_i++){str=_a[_i].extract(str)}if(this.process)for(var _b=0,_c=this.process;_b<_c.length;_b++){str=_c[_b].extract(str)}if(void 0!==this.value)return this.value;if(this.slice){for(var errors=[],index=0;index<this.slice.length;index+=1){var slice=this.slice[index];try{return slice.extract(str)}catch(error){errors.push(error)}}if(this.sliceIsArray){var location_8=errors.map(function(error){return error.at}).join("\n");throw new AtError(messages.inputUnmatched,location_8)}throw errors[0]}return this.array?this.array.extract(str):this.dictionary?this.dictionary.extract(str):str},Slice.prototype.toJSON=function(){var json={};return void 0!==this.has&&(json.has=this.has),void 0!==this.between&&(this.betweenIsArray?json.between=this.between.map(function(item){return item.toJSON()}):json.between=this.between[0].toJSON()),void 0!==this.process&&(this.processIsArray?json.process=this.process.map(function(item){return item.toJSON()}):json.process=this.process[0].toJSON()),void 0!==this.value&&(json.value=this.value),void 0!==this.slice&&(this.sliceIsArray?json.slice=this.slice.map(function(item){return item.toJSON()}):json.slice=this.slice[0].toJSON()),void 0!==this.array&&(json.array=this.array.toJSON()),void 0!==this.dictionary&&(json.dictionary=this.dictionary.toJSON()),json},Slice}()});